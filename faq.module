<?php

/**
 * @file
 * The FAQ module allows users to create a FAQ page, with questions and answers
 * displayed in different styles, according to the settings.
 */

use Drupal\Core\Render\Element;

/**
 * Implements hook_permission().
 */
function faq_permission(){
    /**
     * Permissions of the faq module
     */
    $permissions = array();
    
    $permissions['administer faq'] = array(
        'title' => t('Administer FAQ module'),
        'description' => t('Allows user to administer FAQ module settings')
    );
    
    $permissions['administer faq order'] = array(
        'title' => t('Administer FAQ order'),
        'description' => t('Allows user to order FAQ entities.')
    );
    
    $permissions['view faq page'] = array(
        'title' => t('View FAQ pages'),
        'description' => t('Allows user to view FAQ pages.')
    );
    
    return $permissions;
}

/**
 * Implements hook_theme().
 */
function faq_theme() {
    $path = drupal_get_path('module', 'faq') . '/includes';
    return array(
    'faq_draggable_question_order_table' => array(
      'template' => 'faq-draggable-question-order-table',
      'render element' => 'form',
    ),
    'faq_questions_top' => array(
      'path' => $path,
      'file' => 'faq.questions_top.inc',
      'template' => 'faq-questions-top',
      'variables' => array('data' => NULL),
    ),
    'faq_category_questions_top' => array(
      'path' => $path,
      'file' => 'faq.questions_top.inc',
      'template' => 'faq-category-questions-top',
      'variables' => array('data' => NULL, 'display_header' => 0, 'category_display' => NULL, 'term' => NULL, 'class' => NULL, 'parent_term' => NULL),
    ),
    'faq_category_questions_top_answers' => array(
      'path' => $path,
      'file' => 'faq.questions_top.inc',
      'template' => 'faq-category-questions-top-answers',
      'variables' => array('data' => NULL, 'display_header' => 0, 'category_display' => NULL, 'term' => NULL, 'class' => NULL, 'parent_term' => NULL),
    ),
    'faq_hide_answer' => array(
      'path' => $path,
      'file' => 'faq.hide_answer.inc',
      'template' => 'faq-hide-answer',
      'variables' => array('data' => NULL),
    ),
    'faq_category_hide_answer' => array(
      'path' => $path,
      'file' => 'faq.hide_answer.inc',
      'template' => 'faq-category-hide-answer',
      'variables' => array('data' => NULL, 'display_header' => 0, 'category_display' => NULL, 'term' => NULL, 'class' => NULL, 'parent_term' => NULL),
    ),
    'faq_questions_inline' => array(
      'path' => $path,
      'file' => 'faq.questions_inline.inc',
      'template' => 'faq-questions-inline',
      'variables' => array('data' => NULL),
    ),
    'faq_category_questions_inline' => array(
      'path' => $path,
      'file' => 'faq.questions_inline.inc',
      'template' => 'faq-category-questions-inline',
      'variables' => array('data' => NULL, 'display_header' => 0, 'category_display' => NULL, 'term' => NULL, 'class' => NULL, 'parent_term' => NULL),
    ),
    'faq_new_page' => array(
      'path' => $path,
      'file' => 'faq.new_page.inc',
      'template' => 'faq-new-page',
      'variables' => array('data' => NULL),
    ),
    'faq_category_new_page' => array(
      'path' => $path,
      'file' => 'faq.new_page.inc',
      'template' => 'faq-category-new-page',
      'variables' => array('data' => NULL, 'display_header' => 0, 'category_display' => NULL, 'term' => NULL, 'class' => NULL, 'parent_term' => NULL),
    ),
    'faq_page' => array(
      'variables' => array('content' => '', 'answers' => '', 'description' => NULL),
    ),
  );
}

/**
 * Theme function for question ordering drag and drop table.
 */
function template_preprocess_faq_draggable_question_order_table(&$variables){
  $form = $variables['form'];
  $options = array(
    'table_id' => 'question-sort',
    'action' => 'order',
    'relationship' => 'sibling',
    'group' => 'element-group',
    'hidden' => '3',
  );
  $header = array('', t('Question'), '', t('Sort'));
  $rows = array();
  foreach (Element::children($form) as $key) {
    // Add class to group weight fields for drag and drop.
    $form[$key]['sort']['#attributes']['class'] = array('sort');
    $row = array('');
    $row[] = drupal_render($form[$key]['title']);
    $row[] = drupal_render($form[$key]['nid']);
    $row[] = drupal_render($form[$key]['sort']);
    
    $rows[] = array(
      'data' => $row,
      'class' => array('draggable'),
    );
  }
  
  $table = array(
    '#type' => 'table',
    '#header' => $header,
    '#rows' => $rows,
    '#attributes' => array(
      'id' => 'question-sort',
    ),
  );
  drupal_attach_tabledrag($table, $options);
  $variables['order_table'] = $table;
}
